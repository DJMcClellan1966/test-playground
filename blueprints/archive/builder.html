<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint Builder - Visual Development Environment</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: rgba(0, 0, 0, 0.3);
            --accent: #00b894;
            --accent-hover: #00cec9;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .logo svg {
            width: 24px;
            height: 24px;
            fill: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .sidebar-tab:hover {
            color: var(--text-primary);
        }

        .sidebar-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin: 15px 0 10px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Block Palette */
        .palette-block {
            background: linear-gradient(135deg, #2d3436 0%, #2c3e50 100%);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
        }

        .palette-block:hover {
            transform: translateX(3px);
            border-color: var(--accent);
        }

        .palette-block .name {
            font-weight: 600;
            font-size: 13px;
        }

        .palette-block .desc {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .palette-block.auth { border-left: 3px solid #e74c3c; }
        .palette-block.storage { border-left: 3px solid #3498db; }
        .palette-block.sync { border-left: 3px solid #9b59b6; }
        .palette-block.api { border-left: 3px solid #2ecc71; }
        .palette-block.feature { border-left: 3px solid #f1c40f; }

        /* File Explorer */
        .file-tree {
            font-size: 13px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-item.folder {
            color: var(--accent);
        }

        .file-item .icon {
            font-size: 14px;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-prompt {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-prompt:hover {
            background: var(--accent);
            color: white;
        }

        .user-message {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .ai-message {
            background: rgba(0,184,148,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .toolbar-spacer {
            flex: 1;
        }

        .project-name-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
            width: 200px;
        }

        /* Canvas */
        .canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                linear-gradient(rgba(255,255,255,.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .canvas.drag-over {
            background-color: rgba(0, 184, 148, 0.05);
        }

        .canvas-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #444;
            pointer-events: none;
        }

        /* Placed Blocks */
        .placed-block {
            position: absolute;
            background: linear-gradient(135deg, #2d3436 0%, #2c3e50 100%);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 12px 15px;
            min-width: 160px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .placed-block.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.3);
        }

        .placed-block.auth { border-color: #e74c3c; }
        .placed-block.storage { border-color: #3498db; }
        .placed-block.sync { border-color: #9b59b6; }
        .placed-block.api { border-color: #2ecc71; }
        .placed-block.feature { border-color: #f1c40f; }

        .placed-block .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .placed-block .name {
            font-weight: 600;
            font-size: 13px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 16px;
        }

        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.3);
            color: var(--danger);
        }

        /* Ports */
        .ports {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }

        .port-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .port {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .port-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .port.requires .port-dot { background: var(--danger); }
        .port.provides .port-dot { background: #2ecc71; }

        /* Connections SVG */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .connections-layer path {
            fill: none;
            stroke: var(--accent);
            stroke-width: 2;
            opacity: 0.6;
        }

        /* Right Panel */
        .right-panel {
            width: 350px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .panel-tab:hover {
            color: var(--text-primary);
        }

        .panel-tab.active {
            color: var(--accent);
            background: rgba(0, 184, 148, 0.1);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Code Output */
        .code-output {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 100%;
        }

        /* Entity Builder */
        .entity-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .form-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .fields-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .field-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .field-row input {
            flex: 1;
        }

        .field-row select {
            width: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .field-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
        }

        /* Preview Frame */
        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            border-radius: 8px;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 60px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                <span>Blueprint Builder</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="saveProject()">
                    üíæ Save
                </button>
                <button class="btn btn-secondary" onclick="showNewProjectModal()">
                    üìÅ New Project
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="showSidebarTab('blocks')">Blocks</button>
                    <button class="sidebar-tab" onclick="showSidebarTab('entities')">Entities</button>
                    <button class="sidebar-tab" onclick="showSidebarTab('files')">Files</button>
                    <button class="sidebar-tab" onclick="showSidebarTab('logic')">Logic</button>
                    <button class="sidebar-tab" onclick="showSidebarTab('learn')">Learn</button>
                    <button class="sidebar-tab" onclick="showSidebarTab('ai')">AI</button>
                </div>
                
                <div class="sidebar-content" id="blocks-panel">
                    <div class="section-title">Authentication</div>
                    <div class="palette-block auth" draggable="true" data-type="auth_basic">
                        <div class="name">Basic Auth</div>
                        <div class="desc">Username/password</div>
                    </div>
                    <div class="palette-block auth" draggable="true" data-type="auth_jwt">
                        <div class="name">JWT Auth</div>
                        <div class="desc">Token-based auth</div>
                    </div>

                    <div class="section-title">Storage</div>
                    <div class="palette-block storage" draggable="true" data-type="storage_json">
                        <div class="name">JSON Storage</div>
                        <div class="desc">File-based JSON</div>
                    </div>
                    <div class="palette-block storage" draggable="true" data-type="storage_sqlite">
                        <div class="name">SQLite</div>
                        <div class="desc">Local database</div>
                    </div>

                    <div class="section-title">Sync</div>
                    <div class="palette-block sync" draggable="true" data-type="sync_crdt">
                        <div class="name">CRDT Sync</div>
                        <div class="desc">Conflict-free sync</div>
                    </div>

                    <div class="section-title">API</div>
                    <div class="palette-block api" draggable="true" data-type="crud_routes">
                        <div class="name">CRUD API</div>
                        <div class="desc">REST endpoints</div>
                    </div>

                    <div class="section-title">Features</div>
                    <div class="palette-block feature" draggable="true" data-type="caching">
                        <div class="name">Caching</div>
                        <div class="desc">In-memory cache</div>
                    </div>
                    <div class="palette-block feature" draggable="true" data-type="logging">
                        <div class="name">Logging</div>
                        <div class="desc">Structured logs</div>
                    </div>
                </div>

                <div class="sidebar-content hidden" id="entities-panel">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="showEntityModal()">
                        + New Entity
                    </button>
                    <div id="entities-list">
                        <p style="color: var(--text-secondary); font-size: 12px;">No entities defined yet</p>
                    </div>
                </div>

                <div class="sidebar-content hidden" id="files-panel">
                    <div id="file-tree">
                        <p style="color: var(--text-secondary); font-size: 12px;">Generate a project to see files</p>
                    </div>
                </div>

                <div class="sidebar-content hidden" id="logic-panel">
                    <div style="display: flex; flex-direction: column; height: 100%; gap: 12px;">
                        <!-- CSP Constraint Validation -->
                        <div id="csp-validation" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; font-size: 13px;">Constraint Validation</span>
                                <span id="csp-status" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1);">Checking...</span>
                            </div>
                            <div id="csp-details" style="font-size: 12px; color: var(--text-secondary);"></div>
                            <div id="csp-suggestions" style="margin-top: 8px;"></div>
                        </div>
                        
                        <!-- Completeness Score -->
                        <div style="background: rgba(0,184,148,0.1); padding: 12px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--accent); font-weight: bold;">Completeness</span>
                                <span id="logic-score" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">0%</span>
                            </div>
                            <div style="margin-top: 8px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div id="logic-bar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <!-- Suggestions -->
                        <div style="flex: 1; overflow-y: auto;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px;">Suggestions</div>
                            <div id="logic-suggestions">
                                <p style="color: var(--text-secondary); font-size: 12px;">Analyzing...</p>
                            </div>
                        </div>
                        
                        <!-- Next Steps -->
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px;">Next Steps</div>
                            <div id="logic-nextsteps" style="font-size: 12px; color: var(--text-primary);"></div>
                        </div>
                        
                        <!-- Question Input -->
                        <div style="border-top: 1px solid var(--border); padding-top: 10px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="logic-input" placeholder="Ask about blocks, patterns..." 
                                    style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px;"
                                    onkeypress="if(event.key==='Enter') askLogic()">
                                <button class="btn btn-primary" onclick="askLogic()" style="padding: 8px 12px;">Ask</button>
                            </div>
                            <div style="margin-top: 6px; font-size: 10px; color: var(--text-secondary);">
                                Deterministic ‚Ä¢ No AI ‚Ä¢ Instant
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-content hidden" id="ai-panel">
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 10px; font-size: 13px;">
                            <div class="ai-message" style="background: rgba(0,184,148,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <strong style="color: var(--accent);">AI Advisor</strong><br>
                                <span style="color: var(--text-secondary);">Ask me what blocks you need, how to structure your app, or which blueprint to use. I run locally via Ollama.</span>
                            </div>
                        </div>
                        <div style="padding: 10px; border-top: 1px solid var(--border);">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="ai-input" placeholder="What do you want to build?" 
                                    style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px;"
                                    onkeypress="if(event.key==='Enter') askAI()">
                                <button class="btn btn-primary" onclick="askAI()" style="padding: 8px 12px;">Ask</button>
                            </div>
                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px;">
                                <button class="quick-prompt" onclick="askQuick('What blocks do I need for a blog?')">Blog</button>
                                <button class="quick-prompt" onclick="askQuick('How do I add authentication?')">Auth</button>
                                <button class="quick-prompt" onclick="askQuick('How do I add offline support?')">Offline</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-content hidden" id="learn-panel">
                    <div style="display: flex; flex-direction: column; height: 100%; gap: 12px;">
                        <!-- Level & XP Display -->
                        <div style="background: linear-gradient(135deg, rgba(0,184,148,0.2) 0%, rgba(0,206,201,0.1) 100%); padding: 15px; border-radius: 10px; border: 1px solid rgba(0,184,148,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary);">Level</span>
                                    <div id="learn-level" style="font-size: 20px; font-weight: bold; color: var(--accent); text-transform: capitalize;">Beginner</div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary);">XP</span>
                                    <div style="font-size: 16px; font-weight: bold;"><span id="learn-xp">0</span> / <span id="learn-next-xp">100</span></div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden;">
                                <div id="learn-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #00cec9); transition: width 0.5s;"></div>
                            </div>
                            <div style="margin-top: 5px; font-size: 11px; color: var(--text-secondary);">
                                <span id="learn-projects">0</span> projects completed
                            </div>
                        </div>
                        
                        <!-- Available Projects -->
                        <div style="flex: 1; overflow-y: auto;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; display: flex; justify-content: space-between;">
                                <span>Working Code Projects</span>
                                <span id="learn-project-count"></span>
                            </div>
                            <div id="learn-projects-list" style="display: flex; flex-direction: column; gap: 8px;">
                                <p style="color: var(--text-secondary); font-size: 12px;">Loading projects...</p>
                            </div>
                        </div>
                        
                        <!-- Level-Gated Blocks Info -->
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px;">Next Unlocks</div>
                            <div id="learn-next-unlocks" style="font-size: 12px;">
                                <p style="color: var(--text-secondary);">Loading...</p>
                            </div>
                        </div>
                        
                        <!-- Concepts Learned -->
                        <div style="border-top: 1px solid var(--border); padding-top: 10px;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px;">Concepts Learned</div>
                            <div id="learn-concepts" style="display: flex; flex-wrap: wrap; gap: 4px; font-size: 11px;">
                                <span style="color: var(--text-secondary);">None yet - start a project!</span>
                            </div>
                        </div>
                        
                        <!-- Algorithm Oracle -->
                        <div style="border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px;">üîÆ Algorithm Oracle</div>
                            <div style="margin-bottom: 8px;">
                                <select id="oracle-tags" multiple style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); padding: 4px; font-size: 11px; min-height: 60px;">
                                    <option value="binary_classification">Binary Classification</option>
                                    <option value="regression">Regression</option>
                                    <option value="multi_class">Multi-class</option>
                                    <option value="imbalanced">Imbalanced Data</option>
                                    <option value="high_dimensional">High Dimensional</option>
                                    <option value="few_samples">Few Samples</option>
                                    <option value="text">Text Data</option>
                                    <option value="streaming">Streaming Data</option>
                                    <option value="nonlinear">Nonlinear Patterns</option>
                                    <option value="need_interpretability">Need Interpretability</option>
                                    <option value="safety_critical">Safety Critical</option>
                                </select>
                            </div>
                            <button onclick="queryOracle()" style="width: 100%; padding: 6px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">Ask Oracle</button>
                            <div id="oracle-result" style="margin-top: 8px; font-size: 11px; display: none;">
                                <div style="background: rgba(108, 92, 231, 0.2); padding: 8px; border-radius: 4px; border-left: 3px solid #6c5ce7;">
                                    <div id="oracle-pattern" style="font-weight: bold; margin-bottom: 4px;"></div>
                                    <div id="oracle-suggestion" style="color: var(--text-secondary); margin-bottom: 4px;"></div>
                                    <div id="oracle-why" style="font-style: italic; color: var(--text-secondary); font-size: 10px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Achievements -->
                        <div style="border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px;">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px;">üèÜ Achievements</div>
                            <div id="achievements-streak" style="font-size: 11px; color: var(--accent); margin-bottom: 6px;">
                                üî• 0 day streak
                            </div>
                            <div id="achievements-earned" style="margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                <span style="color: var(--text-secondary); font-size: 11px;">Loading...</span>
                            </div>
                            <button onclick="loadAchievements()" style="width: 100%; padding: 6px; background: linear-gradient(135deg, #ffd93d, #ff9f43); border: none; border-radius: 4px; color: #333; cursor: pointer; font-size: 12px;">View All</button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas -->
            <main class="canvas-container">
                <div class="toolbar">
                    <input type="text" class="project-name-input" id="project-name" value="my_project" placeholder="Project name">
                    <span id="output-path-display" style="color: #888; font-size: 12px; margin-left: 10px; cursor: pointer;" onclick="showBrowserModal()" title="Click to change output folder">‚Üí workspace/</span>
                    
                    <div class="toolbar-spacer"></div>
                    
                    <button class="btn btn-secondary" onclick="autoConnect()">
                        üîó Auto-Connect
                    </button>
                    <button class="btn btn-secondary" onclick="checkConstraints()">
                        ‚úì Check
                    </button>
                    <button class="btn btn-secondary" onclick="showBrowserModal()">
                        üìÅ Browse
                    </button>
                    <button class="btn btn-primary" onclick="generateProject()">
                        üöÄ Generate Project
                    </button>
                    <button class="btn btn-danger" onclick="clearCanvas()">
                        üóëÔ∏è Clear
                    </button>
                </div>
                
                <div class="canvas" id="canvas">
                    <svg class="connections-layer" id="connections"></svg>
                    <div class="canvas-hint" id="canvas-hint">
                        <p>Drag blocks here to design your architecture</p>
                    </div>
                </div>
            </main>

            <!-- Right Panel -->
            <aside class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="showPanelTab('code')">Code</button>
                    <button class="panel-tab" onclick="showPanelTab('preview')">Preview</button>
                    <button class="panel-tab" onclick="showPanelTab('spec')">Spec</button>
                </div>
                
                <div class="panel-content">
                    <div id="code-panel">
                        <pre class="code-output" id="code-output"># Add blocks and generate to see code</pre>
                    </div>
                    <div id="preview-panel" class="hidden">
                        <iframe class="preview-frame" id="preview-frame" src="about:blank"></iframe>
                    </div>
                    <div id="spec-panel" class="hidden">
                        <pre class="code-output" id="spec-output">{}</pre>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="server-status"></span>
                <span id="server-status-text">Connected</span>
            </div>
            <div class="status-item">
                <span id="block-count">0 blocks</span>
                <span>‚Ä¢</span>
                <span id="entity-count">0 entities</span>
            </div>
        </footer>
    </div>

    <!-- Entity Modal -->
    <div class="modal-overlay hidden" id="entity-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Entity</h2>
                <button class="modal-close" onclick="closeEntityModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="entity-form">
                    <div class="form-group">
                        <label class="form-label">Entity Name</label>
                        <input type="text" class="form-input" id="entity-name" placeholder="Task, User, Post...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="entity-description" placeholder="A brief description...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fields</label>
                        <div class="fields-list" id="fields-list">
                            <div class="field-row">
                                <input type="text" class="form-input" placeholder="id">
                                <select>
                                    <option value="string">string</option>
                                    <option value="integer">integer</option>
                                    <option value="boolean">boolean</option>
                                    <option value="datetime">datetime</option>
                                </select>
                                <button class="field-remove" onclick="this.parentElement.remove()">√ó</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="margin-top: 8px;" onclick="addField()">+ Add Field</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Generate For</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label><input type="checkbox" id="lang-python" checked> Python</label>
                            <label><input type="checkbox" id="lang-typescript" checked> TypeScript</label>
                            <label><input type="checkbox" id="lang-go"> Go</label>
                            <label><input type="checkbox" id="lang-rust"> Rust</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEntityModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createEntity()">Create Entity</button>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal-overlay hidden" id="browser-modal">
        <div class="modal" style="width: 700px; max-width: 90vw;">
            <div class="modal-header">
                <h2 class="modal-title">Browse Filesystem</h2>
                <button class="modal-close" onclick="closeBrowserModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow: hidden; display: flex; flex-direction: column;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button class="btn btn-secondary" onclick="browseUp()" id="btn-up">‚Üë Up</button>
                    <input type="text" class="form-input" id="current-path" style="flex: 1;" placeholder="Path...">
                    <button class="btn btn-primary" onclick="browseTo(document.getElementById('current-path').value)">Go</button>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;" id="drive-buttons"></div>
                <div style="flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; min-height: 300px;" id="file-list">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading...</div>
                </div>
                <div style="margin-top: 15px;">
                    <label class="form-label">Selected Output Folder:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="selected-folder" style="flex: 1;" readonly>
                        <button class="btn btn-primary" onclick="setOutputFolder()">Set as Output</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '';  // Same origin
        
        // State
        let placedBlocks = [];
        let connections = [];
        let entities = [];
        let blockIdCounter = 0;
        let serverConnected = true;

        // Block definitions (simplified, full defs come from server)
        const BLOCK_DEFS = {
            auth_basic: { name: "Basic Auth", category: "auth", requires: [], provides: ["auth", "users"] },
            auth_jwt: { name: "JWT Auth", category: "auth", requires: [], provides: ["auth", "tokens"] },
            storage_json: { name: "JSON Storage", category: "storage", requires: [], provides: ["storage"] },
            storage_sqlite: { name: "SQLite", category: "storage", requires: [], provides: ["storage", "database"] },
            sync_crdt: { name: "CRDT Sync", category: "sync", requires: ["storage"], provides: ["sync", "offline"] },
            crud_routes: { name: "CRUD API", category: "api", requires: ["storage"], provides: ["api", "rest"] },
            caching: { name: "Caching", category: "feature", requires: [], provides: ["cache"] },
            logging: { name: "Logging", category: "feature", requires: [], provides: ["logging"] },
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupDragDrop();
            checkServerConnection();
            loadOutputPath();
            loadLearningStatus();
            setInterval(checkServerConnection, 5000);
        });

        function setupDragDrop() {
            const canvas = document.getElementById('canvas');
            
            document.querySelectorAll('.palette-block').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('blockType', block.dataset.type);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });

            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                canvas.classList.add('drag-over');
            });

            canvas.addEventListener('dragleave', () => {
                canvas.classList.remove('drag-over');
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                canvas.classList.remove('drag-over');
                
                const blockType = e.dataTransfer.getData('blockType');
                if (blockType && BLOCK_DEFS[blockType]) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 80;
                    const y = e.clientY - rect.top - 30;
                    addBlock(blockType, x, y);
                }
            });
        }

        function addBlock(type, x, y) {
            const def = BLOCK_DEFS[type];
            const id = ++blockIdCounter;
            
            placedBlocks.push({ id, type, x: Math.max(0, x), y: Math.max(0, y) });
            renderBlocks();
            document.getElementById('canvas-hint').style.display = 'none';
            updateStatus();
            notify(`Added ${def.name}`, 'success');
        }

        function renderBlocks() {
            const canvas = document.getElementById('canvas');
            canvas.querySelectorAll('.placed-block').forEach(el => el.remove());
            
            placedBlocks.forEach(block => {
                const def = BLOCK_DEFS[block.type];
                const el = document.createElement('div');
                el.className = `placed-block ${def.category}`;
                el.style.left = block.x + 'px';
                el.style.top = block.y + 'px';
                el.dataset.id = block.id;
                
                const requiresHtml = def.requires.map(r => 
                    `<div class="port requires"><span class="port-dot"></span>${r}</div>`
                ).join('');
                
                const providesHtml = def.provides.map(p => 
                    `<div class="port provides">${p}<span class="port-dot"></span></div>`
                ).join('');
                
                el.innerHTML = `
                    <div class="header">
                        <span class="name">${def.name}</span>
                        <button class="delete-btn" onclick="removeBlock(${block.id})">√ó</button>
                    </div>
                    <div class="ports">
                        <div class="port-group requires">${requiresHtml}</div>
                        <div class="port-group provides">${providesHtml}</div>
                    </div>
                `;
                
                makeDraggable(el, block);
                canvas.appendChild(el);
            });
            
            renderConnections();
            updateSpec();
        }

        function makeDraggable(el, block) {
            let isDragging = false;
            let startX, startY;
            
            el.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('delete-btn')) return;
                isDragging = true;
                startX = e.clientX - block.x;
                startY = e.clientY - block.y;
                el.style.zIndex = 100;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                block.x = Math.max(0, e.clientX - startX);
                block.y = Math.max(0, e.clientY - startY);
                el.style.left = block.x + 'px';
                el.style.top = block.y + 'px';
                renderConnections();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                el.style.zIndex = 1;
            });
        }

        function removeBlock(id) {
            placedBlocks = placedBlocks.filter(b => b.id !== id);
            connections = connections.filter(c => c.from !== id && c.to !== id);
            
            if (placedBlocks.length === 0) {
                document.getElementById('canvas-hint').style.display = 'block';
            }
            
            renderBlocks();
            updateStatus();
        }

        function autoConnect() {
            connections = [];
            
            placedBlocks.forEach(provider => {
                const providerDef = BLOCK_DEFS[provider.type];
                
                placedBlocks.forEach(consumer => {
                    if (provider.id === consumer.id) return;
                    
                    const consumerDef = BLOCK_DEFS[consumer.type];
                    
                    consumerDef.requires.forEach(req => {
                        if (providerDef.provides.includes(req)) {
                            connections.push({ from: provider.id, to: consumer.id, port: req });
                        }
                    });
                });
            });
            
            renderConnections();
            notify(`Created ${connections.length} connections`, 'info');
        }

        function renderConnections() {
            const svg = document.getElementById('connections');
            const paths = connections.map(conn => {
                const fromBlock = placedBlocks.find(b => b.id === conn.from);
                const toBlock = placedBlocks.find(b => b.id === conn.to);
                
                if (!fromBlock || !toBlock) return '';
                
                const fromX = fromBlock.x + 160;
                const fromY = fromBlock.y + 40;
                const toX = toBlock.x;
                const toY = toBlock.y + 40;
                
                const midX = (fromX + toX) / 2;
                return `<path d="M ${fromX} ${fromY} C ${midX} ${fromY}, ${midX} ${toY}, ${toX} ${toY}"/>`;
            });
            
            svg.innerHTML = paths.join('');
        }

        function clearCanvas() {
            placedBlocks = [];
            connections = [];
            blockIdCounter = 0;
            renderBlocks();
            document.getElementById('canvas-hint').style.display = 'block';
            document.getElementById('code-output').textContent = '# Add blocks and generate to see code';
            updateStatus();
        }

        async function generateProject() {
            if (placedBlocks.length === 0 && entities.length === 0) {
                notify('Add blocks or create entities first!', 'error');
                return;
            }
            
            const projectName = document.getElementById('project-name').value || 'my_project';
            
            const data = {
                name: projectName,
                blocks: placedBlocks.map(b => ({ type: b.type })),
                entities: entities.map(e => ({
                    name: e.name,
                    fields: e.fields.map(f => ({ name: f.name, type: f.type }))
                }))
            };
            
            try {
                const response = await fetch(`${API}/api/scaffold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    notify(`Project generated: ${result.files?.length || 0} files created`, 'success');
                    
                    // Refresh file tree
                    await loadFileTree();
                    
                    // Show generated code
                    await loadGeneratedCode(projectName);
                } else {
                    notify(`Error: ${result.error}`, 'error');
                }
            } catch (err) {
                notify(`Server error: ${err.message}`, 'error');
            }
        }

        async function loadFileTree() {
            try {
                const response = await fetch(`${API}/api/project`);
                const data = await response.json();
                
                const tree = document.getElementById('file-tree');
                
                if (data.files && data.files.length > 0) {
                    // Build tree structure
                    const folders = {};
                    data.files.forEach(file => {
                        const parts = file.path.split('/');
                        const folder = parts.length > 1 ? parts[0] : '';
                        if (!folders[folder]) folders[folder] = [];
                        folders[folder].push(file);
                    });
                    
                    let html = '';
                    Object.entries(folders).forEach(([folder, files]) => {
                        if (folder) {
                            html += `<div class="file-item folder"><span class="icon">üìÅ</span>${folder}</div>`;
                        }
                        files.forEach(file => {
                            const name = file.path.split('/').pop();
                            html += `<div class="file-item" onclick="loadFile('${file.path}')" style="padding-left: ${folder ? '20px' : '8px'}"><span class="icon">üìÑ</span>${name}</div>`;
                        });
                    });
                    
                    tree.innerHTML = html;
                } else {
                    tree.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">No files yet</p>';
                }
            } catch (err) {
                console.error('Failed to load file tree:', err);
            }
        }

        async function loadFile(path) {
            try {
                const response = await fetch(`${API}/api/file?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.content) {
                    document.getElementById('code-output').textContent = data.content;
                    showPanelTab('code');
                }
            } catch (err) {
                notify(`Failed to load file: ${err.message}`, 'error');
            }
        }

        async function loadGeneratedCode(projectName) {
            try {
                const response = await fetch(`${API}/api/file?path=${projectName}/generated_blocks.py`);
                const data = await response.json();
                
                if (data.content) {
                    document.getElementById('code-output').textContent = data.content;
                }
            } catch (err) {
                // File might not exist yet
            }
        }

        function updateSpec() {
            const spec = {
                blocks: placedBlocks.map(b => ({
                    type: b.type,
                    name: BLOCK_DEFS[b.type]?.name,
                    provides: BLOCK_DEFS[b.type]?.provides || [],
                    requires: BLOCK_DEFS[b.type]?.requires || [],
                })),
                entities: entities,
                connections: connections.length,
                capabilities: [...new Set(placedBlocks.flatMap(b => BLOCK_DEFS[b.type]?.provides || []))]
            };
            
            document.getElementById('spec-output').textContent = JSON.stringify(spec, null, 2);
        }

        function checkConstraints() {
            const issues = [];
            
            // Check: storage required for sync/crud
            const hasSync = placedBlocks.some(b => b.type.startsWith('sync_'));
            const hasCrud = placedBlocks.some(b => b.type === 'crud_routes');
            const hasStorage = placedBlocks.some(b => b.type.startsWith('storage_'));
            
            if ((hasSync || hasCrud) && !hasStorage) {
                issues.push('‚ö†Ô∏è Storage block needed for sync/API blocks');
            }
            
            // Check: only one auth
            const authCount = placedBlocks.filter(b => b.type.startsWith('auth_')).length;
            if (authCount > 1) {
                issues.push('‚ö†Ô∏è Multiple auth blocks - consider using just one');
            }
            
            // Check: only one storage
            const storageCount = placedBlocks.filter(b => b.type.startsWith('storage_')).length;
            if (storageCount > 1) {
                issues.push('‚ö†Ô∏è Multiple storage blocks - consider using just one');
            }
            
            if (issues.length === 0) {
                notify('‚úì All constraints satisfied!', 'success');
            } else {
                notify(issues.join('\n'), 'error');
            }
        }

        // Sidebar tabs
        function showSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-content').forEach(c => c.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-panel`).classList.remove('hidden');
        }

        // Panel tabs
        function showPanelTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel-content > div').forEach(c => c.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-panel`).classList.remove('hidden');
        }

        // Entity modal
        function showEntityModal() {
            document.getElementById('entity-modal').classList.remove('hidden');
            document.getElementById('entity-name').focus();
        }

        function closeEntityModal() {
            document.getElementById('entity-modal').classList.add('hidden');
            document.getElementById('entity-name').value = '';
            document.getElementById('entity-description').value = '';
            document.getElementById('fields-list').innerHTML = `
                <div class="field-row">
                    <input type="text" class="form-input" placeholder="id">
                    <select>
                        <option value="string">string</option>
                        <option value="integer">integer</option>
                        <option value="boolean">boolean</option>
                        <option value="datetime">datetime</option>
                    </select>
                    <button class="field-remove" onclick="this.parentElement.remove()">√ó</button>
                </div>
            `;
        }

        // File Browser Functions
        let currentBrowsePath = '';
        
        async function showBrowserModal() {
            document.getElementById('browser-modal').classList.remove('hidden');
            await loadDrives();
            // Start at desktop
            const desktop = await getDesktopPath();
            await browseTo(desktop);
        }
        
        function closeBrowserModal() {
            document.getElementById('browser-modal').classList.add('hidden');
        }
        
        async function getDesktopPath() {
            // Default to user's desktop
            const response = await fetch('/api/browse?path=');
            const data = await response.json();
            return data.path || 'C:\\Users';
        }
        
        async function loadDrives() {
            try {
                const response = await fetch('/api/drives');
                const data = await response.json();
                const container = document.getElementById('drive-buttons');
                
                if (data.drives) {
                    container.innerHTML = data.drives.map(d => 
                        `<button class="quick-prompt" onclick="browseTo('${d.path.replace(/\\/g, '\\\\')}')">${d.name}</button>`
                    ).join('');
                }
            } catch (e) {
                console.error('Error loading drives:', e);
            }
        }
        
        async function browseTo(path) {
            if (!path) return;
            
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
            
            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.error) {
                    fileList.innerHTML = `<div style="padding: 20px; color: var(--danger);">${data.error}</div>`;
                    return;
                }
                
                currentBrowsePath = data.path;
                document.getElementById('current-path').value = data.path;
                document.getElementById('selected-folder').value = data.path;
                
                if (!data.items || data.items.length === 0) {
                    fileList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Empty folder</div>';
                    return;
                }
                
                fileList.innerHTML = data.items.map(item => `
                    <div class="file-item ${item.is_dir ? 'folder' : 'file'}" 
                         onclick="${item.is_dir ? `browseTo('${item.path.replace(/\\/g, '\\\\')}')` : ''}"
                         style="padding: 8px 12px; border-bottom: 1px solid var(--border); cursor: ${item.is_dir ? 'pointer' : 'default'}; display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${item.is_dir ? 'var(--accent)' : 'var(--text-secondary)'};">${item.is_dir ? 'üìÅ' : 'üìÑ'}</span>
                        <span style="flex: 1;">${item.name}</span>
                        ${!item.is_dir && item.size ? `<span style="color: var(--text-secondary); font-size: 11px;">${formatSize(item.size)}</span>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                fileList.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${e.message}</div>`;
            }
        }
        
        async function browseUp() {
            if (!currentBrowsePath) return;
            const response = await fetch(`/api/browse?path=${encodeURIComponent(currentBrowsePath)}`);
            const data = await response.json();
            if (data.parent) {
                await browseTo(data.parent);
            }
        }
        
        async function setOutputFolder() {
            const path = document.getElementById('selected-folder').value;
            if (!path) {
                notify('No folder selected', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/set-output', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update the display
                    document.getElementById('output-path-display').textContent = '‚Üí ' + path;
                    notify(`Output folder set to: ${path}`, 'success');
                    closeBrowserModal();
                } else {
                    notify(data.error || 'Failed to set output folder', 'error');
                }
            } catch (e) {
                notify('Error setting output folder', 'error');
            }
        }
        
        async function loadOutputPath() {
            try {
                const response = await fetch('/api/output-path');
                const data = await response.json();
                if (data.path) {
                    document.getElementById('output-path-display').textContent = '‚Üí ' + data.path;
                }
            } catch (e) {
                // Default display is fine
            }
        }
        
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function addField() {
            const list = document.getElementById('fields-list');
            const row = document.createElement('div');
            row.className = 'field-row';
            row.innerHTML = `
                <input type="text" class="form-input" placeholder="field_name">
                <select>
                    <option value="string">string</option>
                    <option value="integer">integer</option>
                    <option value="boolean">boolean</option>
                    <option value="datetime">datetime</option>
                </select>
                <button class="field-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            list.appendChild(row);
        }

        async function createEntity() {
            const name = document.getElementById('entity-name').value;
            const description = document.getElementById('entity-description').value;
            
            if (!name) {
                notify('Entity name is required', 'error');
                return;
            }
            
            const fieldRows = document.querySelectorAll('#fields-list .field-row');
            const fields = [];
            fieldRows.forEach(row => {
                const nameInput = row.querySelector('input');
                const typeSelect = row.querySelector('select');
                if (nameInput.value) {
                    fields.push({ name: nameInput.value, type: typeSelect.value });
                }
            });
            
            const languages = [];
            if (document.getElementById('lang-python').checked) languages.push('python');
            if (document.getElementById('lang-typescript').checked) languages.push('typescript');
            if (document.getElementById('lang-go').checked) languages.push('go');
            if (document.getElementById('lang-rust').checked) languages.push('rust');
            
            // Save locally
            entities.push({ name, description, fields });
            updateEntitiesList();
            updateStatus();
            
            // Generate on server
            try {
                const response = await fetch(`${API}/api/create-contract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, fields, languages })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    notify(`Entity ${name} created with ${Object.keys(result.generated).length} language files`, 'success');
                    await loadFileTree();
                    
                    // Show the Python code
                    if (result.generated.python) {
                        document.getElementById('code-output').textContent = result.generated.python.code;
                    }
                }
            } catch (err) {
                notify(`Server error: ${err.message}`, 'error');
            }
            
            closeEntityModal();
        }

        function updateEntitiesList() {
            const list = document.getElementById('entities-list');
            
            if (entities.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">No entities defined yet</p>';
                return;
            }
            
            list.innerHTML = entities.map((e, i) => `
                <div class="palette-block" style="border-left: 3px solid #9b59b6;">
                    <div class="name">${e.name}</div>
                    <div class="desc">${e.fields.length} fields</div>
                </div>
            `).join('');
        }

        // Status updates
        function updateStatus() {
            document.getElementById('block-count').textContent = `${placedBlocks.length} blocks`;
            document.getElementById('entity-count').textContent = `${entities.length} entities`;
        }

        async function checkServerConnection() {
            try {
                const response = await fetch(`${API}/api/blocks`);
                if (response.ok) {
                    serverConnected = true;
                    document.getElementById('server-status').classList.remove('disconnected');
                    document.getElementById('server-status-text').textContent = 'Connected';
                }
            } catch (err) {
                serverConnected = false;
                document.getElementById('server-status').classList.add('disconnected');
                document.getElementById('server-status-text').textContent = 'Disconnected';
            }
        }

        async function saveProject() {
            const projectName = document.getElementById('project-name').value || 'my_project';
            
            // Save current state as JSON
            const state = {
                blocks: placedBlocks,
                entities: entities,
                connections: connections,
            };
            
            try {
                await fetch(`${API}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: `${projectName}/project.json`,
                        content: JSON.stringify(state, null, 2)
                    })
                });
                
                notify('Project saved!', 'success');
            } catch (err) {
                notify(`Save failed: ${err.message}`, 'error');
            }
        }

        function showNewProjectModal() {
            const name = prompt('Project name:', 'new_project');
            if (name) {
                document.getElementById('project-name').value = name;
                clearCanvas();
                entities = [];
                updateEntitiesList();
                notify(`New project: ${name}`, 'info');
            }
        }

        // Notifications
        function notify(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.remove(), 4000);
        }

        // AI Chat Functions
        async function askAI() {
            const input = document.getElementById('ai-input');
            const question = input.value.trim();
            if (!question) return;
            
            const messagesDiv = document.getElementById('chat-messages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div class="user-message">
                    <strong style="color: var(--text-primary);">You</strong><br>
                    <span>${escapeHtml(question)}</span>
                </div>
            `;
            
            input.value = '';
            input.disabled = true;
            
            // Add thinking indicator
            const thinkingId = 'thinking-' + Date.now();
            messagesDiv.innerHTML += `
                <div class="ai-message" id="${thinkingId}">
                    <strong style="color: var(--accent);">AI Advisor</strong><br>
                    <span style="color: var(--text-secondary);">Thinking...</span>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                const thinkingDiv = document.getElementById(thinkingId);
                
                if (data.success) {
                    const answer = data.advice || data.response || 'No response';
                    thinkingDiv.innerHTML = `
                        <strong style="color: var(--accent);">AI Advisor</strong><br>
                        <span style="white-space: pre-wrap;">${escapeHtml(answer)}</span>
                    `;
                } else if (data.fallback) {
                    thinkingDiv.innerHTML = `
                        <strong style="color: var(--warning);">AI Advisor (Offline Mode)</strong><br>
                        <span style="color: var(--text-secondary); font-size: 11px;">Local AI not available. Start Ollama with: <code>ollama serve</code></span><br><br>
                        <span>${escapeHtml(data.fallback)}</span>
                    `;
                } else {
                    thinkingDiv.innerHTML = `
                        <strong style="color: var(--danger);">Error</strong><br>
                        <span>${escapeHtml(data.error || 'Unknown error')}</span>
                    `;
                }
            } catch (error) {
                document.getElementById(thinkingId).innerHTML = `
                    <strong style="color: var(--danger);">Connection Error</strong><br>
                    <span>Could not reach the server. Is it running?</span>
                `;
            }
            
            input.disabled = false;
            input.focus();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function askQuick(question) {
            document.getElementById('ai-input').value = question;
            askAI();
        }
        
        // CSP Constraint Validation
        async function validateCSP(blocks, entities) {
            const cspValidation = document.getElementById('csp-validation');
            const cspStatus = document.getElementById('csp-status');
            const cspDetails = document.getElementById('csp-details');
            const cspSuggestions = document.getElementById('csp-suggestions');
            
            // Show loading state
            cspStatus.textContent = 'Checking...';
            cspStatus.style.background = 'rgba(255,255,255,0.1)';
            cspValidation.style.borderLeftColor = 'var(--text-secondary)';
            
            try {
                const response = await fetch('/api/csp/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        blocks: blocks.map(b => ({ type: b })),
                        requirements: {} 
                    })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    // Valid configuration
                    cspStatus.textContent = '‚úì Valid';
                    cspStatus.style.background = 'rgba(0,184,148,0.3)';
                    cspValidation.style.borderLeftColor = 'var(--accent)';
                    
                    const capList = Object.keys(data.capabilities || {})
                        .filter(c => data.capabilities[c])
                        .map(c => c.replace('cap_', ''))
                        .join(', ');
                    
                    cspDetails.innerHTML = `
                        <div style="color: var(--accent);">All constraints satisfied</div>
                        ${capList ? `<div style="margin-top: 4px;">Provides: ${capList}</div>` : ''}
                    `;
                    cspSuggestions.innerHTML = '';
                } else {
                    // Invalid configuration - show conflicts
                    cspStatus.textContent = '‚úó Conflict';
                    cspStatus.style.background = 'rgba(231,76,60,0.3)';
                    cspValidation.style.borderLeftColor = '#e74c3c';
                    
                    cspDetails.innerHTML = `
                        <div style="color: #e74c3c; font-weight: 500;">Constraint Violation</div>
                        <div style="margin-top: 6px; font-size: 11px; white-space: pre-wrap;">${escapeHtml(data.conflicts || 'Unknown conflict')}</div>
                    `;
                    
                    // Show fix suggestions
                    if (data.suggestions && data.suggestions.length > 0) {
                        cspSuggestions.innerHTML = `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">How to fix:</div>
                            ${data.suggestions.map(s => `
                                <div style="background: rgba(0,184,148,0.1); padding: 6px 8px; border-radius: 4px; margin-bottom: 4px; font-size: 11px; cursor: pointer;"
                                     onclick="autoFixCSP('${escapeHtml(s)}')">
                                    <span style="color: var(--accent);">‚Üí</span> ${escapeHtml(s)}
                                </div>
                            `).join('')}
                        `;
                    }
                }
            } catch (e) {
                console.error('CSP validation failed:', e);
                cspStatus.textContent = 'Error';
                cspStatus.style.background = 'rgba(255,255,255,0.1)';
                cspDetails.innerHTML = '<div style="color: var(--text-secondary);">Could not validate</div>';
            }
        }
        
        // Auto-fix from CSP suggestion
        function autoFixCSP(suggestion) {
            // Parse the suggestion to determine what block to add
            if (suggestion.includes('backend_flask') || suggestion.includes('backend_fastapi')) {
                addBlockFromSuggestion('backend_flask');
            } else if (suggestion.includes('storage_json') || suggestion.includes('storage_sqlite')) {
                addBlockFromSuggestion('storage_sqlite');
            } else if (suggestion.includes('auth_basic') || suggestion.includes('auth_oauth')) {
                addBlockFromSuggestion('auth_basic');
            } else if (suggestion.includes('crdt_sync')) {
                addBlockFromSuggestion('sync_crdt');
            } else if (suggestion.includes('Remove')) {
                // For conflict removals, user needs to manually choose
                alert('Please remove one of the conflicting blocks manually');
            }
        }
        
        // Solve CSP to auto-add required blocks
        async function solveCSP() {
            const blocks = placedBlocks.map(b => b.type);
            
            try {
                const response = await fetch('/api/csp/solve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blocks: blocks.map(b => ({ type: b })),
                        requirements: {}
                    })
                });
                
                const data = await response.json();
                
                if (data.valid && data.autoAdded && data.autoAdded.length > 0) {
                    // Add the required blocks
                    for (const block of data.autoAdded) {
                        addBlockFromSuggestion(block);
                    }
                    showStatus(`Added ${data.autoAdded.length} required block(s): ${data.autoAdded.join(', ')}`, 'success');
                    analyzeLogic();
                } else if (!data.valid) {
                    showStatus('Could not solve constraints: ' + (data.conflicts || 'unknown issue'), 'error');
                } else {
                    showStatus('Configuration already complete', 'info');
                }
            } catch (e) {
                console.error('CSP solve failed:', e);
            }
        }
        
        // Logic Advisor Functions (Deterministic)
        async function analyzeLogic() {
            // Collect current state
            const blocks = placedBlocks.map(b => b.type);
            const entityData = entities.map(e => ({
                name: e.name,
                fields: e.fields
            }));
            
            // Run CSP validation in parallel with logic analysis
            validateCSP(blocks, entityData);
            
            try {
                const response = await fetch('/api/logic/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blocks, entities: entityData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update completeness score
                    document.getElementById('logic-score').textContent = data.completeness + '%';
                    document.getElementById('logic-bar').style.width = data.completeness + '%';
                    
                    // Color based on score
                    const bar = document.getElementById('logic-bar');
                    if (data.completeness < 30) bar.style.background = '#e74c3c';
                    else if (data.completeness < 70) bar.style.background = '#f39c12';
                    else bar.style.background = 'var(--accent)';
                    
                    // Update suggestions
                    const suggestionsDiv = document.getElementById('logic-suggestions');
                    if (data.suggestions && data.suggestions.length > 0) {
                        suggestionsDiv.innerHTML = data.suggestions.map(s => `
                            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-bottom: 8px; cursor: ${s.action ? 'pointer' : 'default'};"
                                 ${s.action ? `onclick="addBlockFromSuggestion('${s.action}')"` : ''}>
                                <div style="color: var(--text-primary); font-size: 12px; font-weight: 500;">${escapeHtml(s.title)}</div>
                                <div style="color: var(--text-secondary); font-size: 11px; margin-top: 4px;">${escapeHtml(s.reason)}</div>
                                ${s.action ? `<div style="color: var(--accent); font-size: 10px; margin-top: 4px;">Click to add ${s.action}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        suggestionsDiv.innerHTML = '<p style="color: var(--accent); font-size: 12px;">Looking good! No issues detected.</p>';
                    }
                    
                    // Update next steps
                    const nextStepsDiv = document.getElementById('logic-nextsteps');
                    if (data.next_steps && data.next_steps.length > 0) {
                        nextStepsDiv.innerHTML = data.next_steps.map(s => 
                            `<div style="margin-bottom: 4px;">‚Ä¢ ${escapeHtml(s)}</div>`
                        ).join('');
                    }
                    
                    // Show warnings
                    if (data.warnings && data.warnings.length > 0) {
                        suggestionsDiv.innerHTML += `
                            <div style="background: rgba(231,76,60,0.1); padding: 8px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #e74c3c;">
                                <div style="color: #e74c3c; font-size: 11px; font-weight: bold;">Warnings</div>
                                ${data.warnings.map(w => `<div style="font-size: 11px; margin-top: 4px;">${escapeHtml(w)}</div>`).join('')}
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Logic analysis failed:', e);
            }
        }
        
        async function askLogic() {
            const input = document.getElementById('logic-input');
            const question = input.value.trim();
            if (!question) return;
            
            input.disabled = true;
            
            const blocks = placedBlocks.map(b => b.type);
            const entityData = entities.map(e => ({ name: e.name, fields: e.fields }));
            
            try {
                const response = await fetch('/api/logic/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        context: { blocks, entities: entityData }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show answer in suggestions area
                    document.getElementById('logic-suggestions').innerHTML = `
                        <div style="background: rgba(0,184,148,0.1); padding: 10px; border-radius: 6px;">
                            <div style="color: var(--accent); font-size: 11px; margin-bottom: 6px;">Answer (via Logic)</div>
                            <div style="color: var(--text-primary); font-size: 12px; white-space: pre-wrap;">${escapeHtml(data.response)}</div>
                        </div>
                        <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="analyzeLogic()">
                            ‚Üê Back to Analysis
                        </button>
                    `;
                }
            } catch (e) {
                console.error('Logic ask failed:', e);
            }
            
            input.value = '';
            input.disabled = false;
        }
        
        function addBlockFromSuggestion(blockType) {
            // Simulate dropping a block on the canvas
            if (BLOCK_DEFS[blockType]) {
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                const x = 100 + Math.random() * 200;
                const y = 100 + Math.random() * 150;
                
                createBlock(blockType, x, y);
                notify(`Added ${blockType}`, 'success');
                
                // Re-analyze
                setTimeout(analyzeLogic, 100);
            }
        }
        
        // Auto-analyze when state changes
        const originalUpdateEntitiesList = updateEntitiesList;
        updateEntitiesList = function() {
            originalUpdateEntitiesList();
            if (document.getElementById('logic-panel') && !document.getElementById('logic-panel').classList.contains('hidden')) {
                analyzeLogic();
            }
        };
        
        // Analyze when logic tab is shown
        const originalShowSidebarTab = showSidebarTab;
        showSidebarTab = function(tabName) {
            originalShowSidebarTab(tabName);
            if (tabName === 'logic') {
                analyzeLogic();
            } else if (tabName === 'learn') {
                loadLearningStatus();
            }
        };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // ========================================================================
        // LEARNING SYSTEM - Level-gated blocks with XP progression
        // ========================================================================
        
        async function loadLearningStatus() {
            try {
                const [statusRes, projectsRes, blocksRes] = await Promise.all([
                    fetch('/api/learning/status', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
                    fetch('/api/learning/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
                    fetch('/api/learning/blocks', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                ]);
                
                const status = await statusRes.json();
                const projects = await projectsRes.json();
                const blocks = await blocksRes.json();
                
                if (status.success) {
                    updateLearningUI(status, projects, blocks);
                }
            } catch (e) {
                console.error('Failed to load learning status:', e);
                document.getElementById('learn-projects-list').innerHTML = 
                    '<p style="color: var(--text-secondary); font-size: 12px;">Server not connected</p>';
            }
        }
        
        function updateLearningUI(status, projects, blocks) {
            // Update level and XP
            document.getElementById('learn-level').textContent = status.level || 'beginner';
            document.getElementById('learn-xp').textContent = status.xp || 0;
            document.getElementById('learn-next-xp').textContent = status.next_level_at || 100;
            document.getElementById('learn-projects').textContent = status.projects_completed || 0;
            
            // Update progress bar
            const progress = status.progress_percent || 0;
            document.getElementById('learn-progress-bar').style.width = progress + '%';
            
            // Update available projects
            const projectsList = document.getElementById('learn-projects-list');
            if (projects.available && Object.keys(projects.available).length > 0) {
                projectsList.innerHTML = Object.entries(projects.available).map(([id, proj]) => `
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 3px solid var(--accent);"
                         onclick="getProjectCode('${id}')"
                         onmouseover="this.style.transform='translateX(3px)'"
                         onmouseout="this.style.transform='none'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 13px;">${escapeHtml(proj.name)}</span>
                            <span style="font-size: 11px; color: var(--accent);">+${proj.xp_reward} XP</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(proj.description)}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                            ${proj.teaches.slice(0, 3).map(t => `<span style="font-size: 10px; background: rgba(0,184,148,0.2); padding: 2px 6px; border-radius: 3px; color: var(--accent);">${t}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('learn-project-count').textContent = Object.keys(projects.available).length + ' available';
            } else {
                projectsList.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">No projects available at your level yet.</p>';
            }
            
            // Update locked projects (next unlocks)
            const nextUnlocks = document.getElementById('learn-next-unlocks');
            if (projects.locked && Object.keys(projects.locked).length > 0) {
                const locked = Object.entries(projects.locked).slice(0, 2);
                nextUnlocks.innerHTML = locked.map(([id, proj]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; opacity: 0.6;">
                        <span>üîí ${escapeHtml(proj.name)}</span>
                        <span style="font-size: 10px; color: var(--text-secondary);">${proj.requires_level}</span>
                    </div>
                `).join('');
            } else {
                nextUnlocks.innerHTML = '<span style="color: var(--accent);">All projects unlocked!</span>';
            }
            
            // Update concepts learned
            const conceptsDiv = document.getElementById('learn-concepts');
            if (status.concepts_learned && status.concepts_learned.length > 0) {
                conceptsDiv.innerHTML = status.concepts_learned.map(c => 
                    `<span style="background: rgba(0,184,148,0.2); color: var(--accent); padding: 2px 6px; border-radius: 3px;">${c}</span>`
                ).join('');
            } else {
                conceptsDiv.innerHTML = '<span style="color: var(--text-secondary);">None yet - start a project!</span>';
            }
        }
        
        async function getProjectCode(projectId) {
            try {
                const response = await fetch('/api/learning/get-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId })
                });
                
                const data = await response.json();
                
                if (data.success && data.available) {
                    // Show the code in the code display area
                    showProjectCode(data);
                    
                    // Check for level up
                    if (data.leveled_up) {
                        setTimeout(() => {
                            notify(`üéâ LEVEL UP! You're now ${data.level}!`, 'success');
                        }, 500);
                    }
                    
                    // Refresh learning UI
                    loadLearningStatus();
                } else if (data.available === false) {
                    notify(`Project locked - requires ${data.requires_level} level`, 'error');
                } else {
                    notify('Failed to get project code', 'error');
                }
            } catch (e) {
                console.error('Failed to get project code:', e);
                notify('Failed to get project code', 'error');
            }
        }
        
        function showProjectCode(data) {
            // Create a modal to show the code
            const modal = document.createElement('div');
            modal.id = 'code-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-secondary); border-radius: 12px;
                max-width: 800px; width: 90%; max-height: 80vh;
                display: flex; flex-direction: column; overflow: hidden;
            `;
            
            content.innerHTML = `
                <div style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: var(--text-primary);">${escapeHtml(data.name)}</h3>
                        <div style="font-size: 12px; color: var(--accent); margin-top: 4px;">
                            +${data.xp_gained} XP earned ‚Ä¢ Total: ${data.total_xp} XP
                        </div>
                    </div>
                    <button onclick="this.closest('#code-modal').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer;">√ó</button>
                </div>
                <div style="padding: 10px 20px; background: rgba(0,184,148,0.1); border-bottom: 1px solid var(--border);">
                    <span style="font-size: 11px; color: var(--text-secondary);">Concepts learned:</span>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                        ${data.teaches.map(t => `<span style="background: rgba(0,184,148,0.2); color: var(--accent); padding: 2px 6px; border-radius: 3px; font-size: 11px;">${t}</span>`).join('')}
                    </div>
                </div>
                <div style="flex: 1; overflow: auto; padding: 0;">
                    <pre style="margin: 0; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5; background: #1a1a2e; color: #e0e0e0; overflow-x: auto;"><code>${escapeHtml(data.code)}</code></pre>
                </div>
                <div style="padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="copyCode()" style="flex: 1;">Copy Code</button>
                    <button class="btn btn-secondary" onclick="saveProjectFile('${escapeHtml(data.name).replace(/[^a-z0-9]/gi, '_').toLowerCase()}.py')" style="flex: 1;">Save to File</button>
                    <button class="btn btn-secondary" onclick="this.closest('#code-modal').remove()">Close</button>
                </div>
            `;
            
            // Store code for copy function
            content.dataset.code = data.code;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function copyCode() {
            const modal = document.getElementById('code-modal');
            if (modal) {
                const code = modal.querySelector('div').dataset.code;
                navigator.clipboard.writeText(code).then(() => {
                    notify('Code copied to clipboard!', 'success');
                }).catch(() => {
                    notify('Failed to copy code', 'error');
                });
            }
        }
        
        async function saveProjectFile(filename) {
            const modal = document.getElementById('code-modal');
            if (modal) {
                const code = modal.querySelector('div').dataset.code;
                try {
                    const response = await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: filename,
                            content: code
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        notify(`Saved to workspace/${filename}`, 'success');
                        // Record project completion for XP
                        await fetch('/api/learning/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        loadLearningStatus();
                    } else {
                        notify('Failed to save: ' + (data.error || 'unknown'), 'error');
                    }
                } catch (e) {
                    notify('Failed to save file', 'error');
                }
            }
        }
        
        // Track block usage for learning XP
        const originalAddBlock = addBlock;
        addBlock = function(type, x, y) {
            originalAddBlock(type, x, y);
            // Record block use in learning system
            fetch('/api/learning/use-block', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ block: type })
            }).catch(() => {}); // Silent fail if server not running
        };
        
        // Algorithm Oracle - query for pattern advice
        async function queryOracle() {
            const select = document.getElementById('oracle-tags');
            const selectedTags = Array.from(select.selectedOptions).map(opt => opt.value);
            
            if (selectedTags.length === 0) {
                notify('Select at least one tag to query the oracle', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/learning/oracle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile: selectedTags })
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('oracle-result');
                
                if (data.success && data.top_recommendation) {
                    const rec = data.top_recommendation;
                    document.getElementById('oracle-pattern').textContent = 'üìã ' + rec.pattern;
                    document.getElementById('oracle-suggestion').textContent = rec.suggestion;
                    document.getElementById('oracle-why').textContent = 'üí° ' + rec.why;
                    resultDiv.style.display = 'block';
                } else if (data.matches && data.matches.length === 0) {
                    document.getElementById('oracle-pattern').textContent = 'No matching patterns';
                    document.getElementById('oracle-suggestion').textContent = 'Try different tags or combinations';
                    document.getElementById('oracle-why').textContent = '';
                    resultDiv.style.display = 'block';
                } else {
                    notify('Oracle query failed', 'error');
                }
            } catch (e) {
                console.error('Oracle query failed:', e);
                notify('Oracle query failed - server not connected', 'error');
            }
        }
        
        // Load and display achievements
        async function loadAchievements() {
            try {
                const response = await fetch('/api/learning/achievements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update streak display
                    const streakEl = document.getElementById('achievements-streak');
                    const days = data.streak_days || 0;
                    streakEl.textContent = `üî• ${days} day${days !== 1 ? 's' : ''} streak`;
                    
                    // Update earned achievements
                    const earnedEl = document.getElementById('achievements-earned');
                    if (data.earned && data.earned.length > 0) {
                        earnedEl.innerHTML = data.earned.map(a => 
                            `<span title="${a.description}" style="background: rgba(255, 217, 61, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: help;">${a.name}</span>`
                        ).join('');
                    } else {
                        earnedEl.innerHTML = '<span style="color: var(--text-secondary); font-size: 11px;">No achievements yet</span>';
                    }
                    
                    // Show progress
                    const total = data.total_available || 0;
                    const earned = data.total_earned || 0;
                    notify(`Achievements: ${earned}/${total} earned`, 'success');
                }
            } catch (e) {
                console.error('Failed to load achievements:', e);
            }
        }
        
        // Load achievements on page load
        setTimeout(loadAchievements, 2000);
    </script>
</body>
</html>
