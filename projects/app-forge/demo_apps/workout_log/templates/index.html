<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Workout Log</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .navbar { background: #ff7a59; color: white; padding: 14px 20px; display: flex; align-items: center; gap: 20px; }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; font-size: 14px; opacity: .85; }
        .navbar a:hover { opacity: 1; }
        .container { max-width: 900px; margin: 24px auto; padding: 0 16px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
        input, textarea, select { padding: 9px 11px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #ff7a59; box-shadow: 0 0 0 3px rgba(255,122,89,.12); }
        button { padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all .2s; }
        .btn-primary { background: #ff7a59; color: white; }
        .btn-primary:hover { background: #ff6b3f; transform: translateY(-1px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: transparent; color: #dc3545; font-size: 18px; padding: 4px 10px; border-radius: 4px; }
        .btn-danger:hover { background: #ffeaea; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: .5px; }
        tr:hover td { background: #fafafa; }
        .hidden { display: none; }
        .section { display: none; }
        .section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-field { display: flex; flex-direction: column; }
        .form-field.full-width { grid-column: 1 / -1; }
        .form-field label { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 4px; }
        .form-field label input[type="checkbox"] { width: auto; margin-right: 6px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #bbb; font-size: 15px; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #2ecc71; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; transform: translateY(80px); opacity: 0; transition: all .3s; z-index: 999; pointer-events: none; }
        .toast.show { transform: translateY(0); opacity: 1; }
        #auth-section { margin-bottom: 16px; }
        .form-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .form-row > * { flex: 1; min-width: 150px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Workout Log</h1>
        <a href="#" onclick="showSection('workout')">Workouts</a>
        <a href="#" onclick="showSection('habit')">Habits</a>

    </nav>
    <div class="container">

        <div id="auth-section" class="card">
            <div id="auth-forms">
                <h3>Login or Register</h3>
                <div class="form-row">
                    <input id="auth-username" placeholder="Username">
                    <input id="auth-email" placeholder="Email">
                    <input id="auth-password" type="password" placeholder="Password">
                </div>
                <button class="btn-primary" onclick="doRegister()">Register</button>
                <button class="btn-secondary" onclick="doLogin()">Login</button>
            </div>
            <div id="auth-info" class="hidden">
                <p>Logged in as <strong id="auth-name"></strong>
                <button class="btn-secondary" onclick="doLogout()">Logout</button></p>
            </div>
        </div>

        <div id="section-workout" class="section card">
            <h2 style="margin-bottom:16px">Workouts</h2>
            <input id="search-workout" placeholder="Search Workouts..." oninput="loadWorkouts()" style="margin-bottom:16px">
            <form id="form-workout" onsubmit="return addWorkout()">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="add-workout-name">Name *</label>
                        <input id="add-workout-name" required>
                    </div>
                    <div class="form-field">
                        <label for="add-workout-exercise_type">Exercise Type</label>
                        <input id="add-workout-exercise_type">
                    </div>
                    <div class="form-field">
                        <label for="add-workout-sets">Sets</label>
                        <input type="number" step="1" id="add-workout-sets">
                    </div>
                    <div class="form-field">
                        <label for="add-workout-reps">Reps</label>
                        <input type="number" step="1" id="add-workout-reps">
                    </div>
                    <div class="form-field">
                        <label for="add-workout-weight">Weight</label>
                        <input type="number" step="0.1" id="add-workout-weight">
                    </div>
                    <div class="form-field">
                        <label for="add-workout-duration_minutes">Duration Minutes</label>
                        <input type="number" step="1" id="add-workout-duration_minutes">
                    </div>
                    <div class="form-field full-width">
                        <label for="add-workout-notes">Notes</label>
                        <textarea id="add-workout-notes" rows="3"></textarea>
                    </div>
                </div>
                <div style="margin-top:14px">
                    <button type="submit" class="btn-primary">Add Workout</button> <button type="button" class="btn-secondary" onclick="window.location='/api/workouts/export'">Export CSV</button>
                </div>
            </form>
            <div id="empty-workout" class="empty-state">No workouts yet &mdash; add your first one above!</div>
            <table id="table-wrap-workout" style="display:none">
                <thead><tr><th>Name</th><th>Exercise Type</th><th>Sets</th><th>Reps</th><th>Weight</th><th style="width:50px"></th></tr></thead>
                <tbody id="table-workout"></tbody>
            </table>
        </div>
        <div id="section-habit" class="section card">
            <h2 style="margin-bottom:16px">Habits</h2>
            <input id="search-habit" placeholder="Search Habits..." oninput="loadHabits()" style="margin-bottom:16px">
            <form id="form-habit" onsubmit="return addHabit()">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="add-habit-name">Name *</label>
                        <input id="add-habit-name" required>
                    </div>
                    <div class="form-field full-width">
                        <label for="add-habit-description">Description</label>
                        <textarea id="add-habit-description" rows="3"></textarea>
                    </div>
                    <div class="form-field">
                        <label for="add-habit-target_per_day">Target Per Day</label>
                        <input type="number" step="1" id="add-habit-target_per_day">
                    </div>
                    <div class="form-field">
                        <label><input type="checkbox" id="add-habit-completed_today"> Completed Today</label>
                    </div>
                    <div class="form-field">
                        <label for="add-habit-streak">Streak</label>
                        <input type="number" step="1" id="add-habit-streak">
                    </div>
                </div>
                <div style="margin-top:14px">
                    <button type="submit" class="btn-primary">Add Habit</button> <button type="button" class="btn-secondary" onclick="window.location='/api/habits/export'">Export CSV</button>
                </div>
            </form>
            <div id="empty-habit" class="empty-state">No habits yet &mdash; add your first one above!</div>
            <table id="table-wrap-habit" style="display:none">
                <thead><tr><th>Name</th><th>Target Per Day</th><th>Completed Today</th><th>Streak</th><th style="width:50px"></th></tr></thead>
                <tbody id="table-habit"></tbody>
            </table>
        </div>
    </div>
    <div id="toast" class="toast"></div>
<script>

    function showToast(msg) {
        var t = document.getElementById('toast');
        t.textContent = msg; t.classList.add('show');
        setTimeout(function(){ t.classList.remove('show'); }, 2000);
    }
    function showSection(name) {
        document.querySelectorAll('.section').forEach(function(s){ s.classList.remove('active'); });
        var el = document.getElementById('section-' + name);
        if (el) el.classList.add('active');
    }


    async function checkAuth() {
        var res = await fetch('/api/me');
        var data = await res.json();
        if (data.user) {
            document.getElementById('auth-forms').classList.add('hidden');
            document.getElementById('auth-info').classList.remove('hidden');
            document.getElementById('auth-name').textContent = data.user.username;
        } else {
            document.getElementById('auth-forms').classList.remove('hidden');
            document.getElementById('auth-info').classList.add('hidden');
        }
    }
    async function doRegister() {
        var res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                username: document.getElementById('auth-username').value,
                email: document.getElementById('auth-email').value,
                password: document.getElementById('auth-password').value,
            })});
        var data = await res.json();
        if (data.error) { alert(data.error); return; }
        checkAuth();
    }
    async function doLogin() {
        var res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                email: document.getElementById('auth-email').value,
                password: document.getElementById('auth-password').value,
            })});
        var data = await res.json();
        if (data.error) { alert(data.error); return; }
        checkAuth();
    }
    async function doLogout() {
        await fetch('/api/logout', {method:'POST'});
        checkAuth();
    }
    checkAuth();


    async function loadWorkouts() {
        var q = document.getElementById('search-workout') ? document.getElementById('search-workout').value : '';
        var url = '/api/workouts' + (q ? '?q=' + encodeURIComponent(q) : '');
        var res = await fetch(url);
        var items = await res.json();
        if (items.length === 0) {
            document.getElementById('empty-workout').style.display = 'block';
            document.getElementById('table-wrap-workout').style.display = 'none';
        } else {
            document.getElementById('empty-workout').style.display = 'none';
            document.getElementById('table-wrap-workout').style.display = 'table';
            document.getElementById('table-workout').innerHTML = items.map(function(item) {
                return `<tr><td>${item.name || ''}</td><td>${item.exercise_type || ''}</td><td>${item.sets || ''}</td><td>${item.reps || ''}</td><td>${item.weight || ''}</td><td><button class='btn-danger' onclick='deleteWorkout(${item.id})'>&#215;</button></td></tr>`;
            }).join('');
        }
    }
    async function addWorkout() {
        await fetch('/api/workouts', { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name: document.getElementById('add-workout-name').value, exercise_type: document.getElementById('add-workout-exercise_type').value, sets: parseInt(document.getElementById('add-workout-sets').value) || 0, reps: parseInt(document.getElementById('add-workout-reps').value) || 0, weight: parseFloat(document.getElementById('add-workout-weight').value) || 0, duration_minutes: parseInt(document.getElementById('add-workout-duration_minutes').value) || 0, notes: document.getElementById('add-workout-notes').value }) });
        document.getElementById('form-workout').reset();
        showToast('Workout added!');
        loadWorkouts();
        return false;
    }
    async function deleteWorkout(id) {
        await fetch('/api/workouts/' + id, { method:'DELETE' });
        showToast('Workout removed');
        loadWorkouts();
    }
    loadWorkouts();


    async function loadHabits() {
        var q = document.getElementById('search-habit') ? document.getElementById('search-habit').value : '';
        var url = '/api/habits' + (q ? '?q=' + encodeURIComponent(q) : '');
        var res = await fetch(url);
        var items = await res.json();
        if (items.length === 0) {
            document.getElementById('empty-habit').style.display = 'block';
            document.getElementById('table-wrap-habit').style.display = 'none';
        } else {
            document.getElementById('empty-habit').style.display = 'none';
            document.getElementById('table-wrap-habit').style.display = 'table';
            document.getElementById('table-habit').innerHTML = items.map(function(item) {
                return `<tr><td>${item.name || ''}</td><td>${item.target_per_day || ''}</td><td>${item.completed_today ? '&#10003;' : ''}</td><td>${item.streak || ''}</td><td><button class='btn-danger' onclick='deleteHabit(${item.id})'>&#215;</button></td></tr>`;
            }).join('');
        }
    }
    async function addHabit() {
        await fetch('/api/habits', { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name: document.getElementById('add-habit-name').value, description: document.getElementById('add-habit-description').value, target_per_day: parseInt(document.getElementById('add-habit-target_per_day').value) || 0, completed_today: document.getElementById('add-habit-completed_today').checked, streak: parseInt(document.getElementById('add-habit-streak').value) || 0 }) });
        document.getElementById('form-habit').reset();
        showToast('Habit added!');
        loadHabits();
        return false;
    }
    async function deleteHabit(id) {
        await fetch('/api/habits/' + id, { method:'DELETE' });
        showToast('Habit removed');
        loadHabits();
    }
    loadHabits();

    showSection('workout');
</script>
</body>
</html>
